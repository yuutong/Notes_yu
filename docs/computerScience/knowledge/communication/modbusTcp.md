
**大白话版：**

* Modbus TCP 就像是在互联网上打电话：底层用 TCP/IP 来保证“通话”稳定不漏话，然后在“通话内容”前面加上一段小标题（MBAP 头），告诉对方“这是第几次通话”“是什么协议”“接下来有多长”“给哪个设备听”，接着说“我要读寄存器”“或者我想写值”。对方接到后就根据这段小标题和后面的功能码去做相应操作，无需再单独做 CRC 校验，因为 TCP 已经帮你保证了数据完整性。

---

**专业术语版：**

1. **传输层／网络层（Transport/Network Layer）**

   * **TCP/IP**：采用面向连接的 TCP 协议（默认端口 502），在网络层和传输层提供可靠的字节流服务，包括分段、重传、校验和流量控制。

2. **应用层（Application Layer）**

   * **Modbus TCP 协议**：在每个 TCP 报文的数据部分封装 Modbus PDU（功能码 + 数据），并在前面加一个 7 字节的 **MBAP（Modbus Application Protocol）头**，用于事务管理和多单元识别。

   * **MBAP 报文头格式**（共 7 字节）：

     | 字段              | 长度 | 说明                              |
     | --------------- | -: | ------------------------------- |
     | 事务标识符           |  2 | 由客户端生成，用于请求–响应匹配                |
     | 协议标识符           |  2 | 固定为 0，表示 Modbus 协议              |
     | 长度              |  2 | 后续字节数（字节计数：Unit ID + 功能码 + 数据域） |
     | 单元标识符 (Unit ID) |  1 | 在网关或多单元环境下标记目标从站，等同于 RTU 里“站号”  |

   * **Modbus PDU**：紧跟在 MBAP 后，包括 1 字节功能码（Function Code）和若干字节数据域（Data）。

3. **与 Modbus RTU 的对比**

   * **Modbus RTU**：

     * 物理/链路层用 RS‑485/RS‑232，帧边界由静默时间区分，帧尾靠 CRC‑16 校验保证完整性。
   * **Modbus TCP**：

     * 物理/链路层用以太网＋TCP/IP，TCP 保证可靠传输，无需 CRC；
     * 应用层在 PDU 前加 MBAP 头管理事务和单元，其他功能码和数据域与 RTU 一致。

4. **流程示例**

   1. **客户端** 建立 TCP 连接到服务器（IP:502）。
   2. 构造 **MBAP 头** + **Modbus PDU**（例如读寄存器功能码 0x03 + 地址 + 长度）。
   3. 通过 TCP 发给服务器。
   4. **服务器** 解析 MBAP 头，交给 Modbus 处理逻辑，按功能码读取寄存器，生成 PDU 响应；填写相同的事务标识符等 MBAP 字段，回传。
   5. **客户端** 收到响应，匹配事务标识符，提取数据进行后续处理。

---

